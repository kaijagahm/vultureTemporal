---
title: "Heuristic"
format: html
editor: visual
---

```{r}
library(targets)
library(igraph)
library(tidyverse)
tar_config_set(
  script = here::here('_targets.R'),
  store = here::here('_targets')
)
theme_set(theme_classic())
source(here::here("R/functions.R"))
```

## Load data

```{r}
tar_load(timewindows_heuristic)
tar_load(timewindows)
tar_load(graphs_flight_heuristic)
tar_load(graphs_feeding_heuristic)
tar_load(graphs_flight)
tar_load(graphs_feeding)
```

General TWIN algorithm from the paper Meaningful Selection of Temporal Resolution for Dynamic Networks (Sulo et al. 2010)

for w = 1 to wmax, do:

compute the time series of graphs G(w)

Compute the time series Fw

if V(Fw) - R(Fw) \< gamma then

output w

end if

end for

Okay, so we have G(w) for each of five w values (stored above as graphs_flight).

Now let's compute F(w) for a few different measures. Density and diameter are easiest in igraph so let's start there, and we can also add transitivity

```{r}
nonzero <- function(g){
  gg <- delete_edges(g, which(E(g)$weight==0))
  return(gg)
}

fl_density <- map(graphs_flight_heuristic, ~map_dbl(.x, ~igraph::edge_density(nonzero(.x))))
fe_density <- map(graphs_feeding_heuristic, ~map_dbl(.x, ~igraph::edge_density(nonzero(.x))))

fl_density_orig <- map(graphs_flight, ~map_dbl(.x, ~igraph::edge_density(nonzero(.x))))
fe_density_orig <- map(graphs_feeding, ~map_dbl(.x, ~igraph::edge_density(nonzero(.x))))
```

Let's visualize those over time, just for the sake of it

```{r}
#| warning: false
#| message: false

getmeasures <- function(dens, tw, sitch){
  out <- map2(.x = dens, .y = tw,
              ~data.frame(dens = .x, 
                          w = .y, 
                          situ = sitch) %>%
                mutate(step = 1:n(),
                       time = step*w))
  return(out)
}
measures_fl <- getmeasures(fl_density, timewindows_heuristic, "flight")
measures_fe <- getmeasures(fe_density, timewindows_heuristic, "feeding")

measures_fl_orig <- getmeasures(fl_density_orig, timewindows, "flight")
measures_fe_orig <- getmeasures(fe_density_orig, timewindows, "feeding")

all <- list(measures_fl, measures_fe, measures_fl_orig, measures_fe_orig)
all <- map(all, list_rbind)

measures <- do.call(rbind, all) %>%
  rename("density" = dens) %>%
  arrange(situ, w)

# Visualize: daily
measures %>%
  ggplot(aes(x = w, y = density, col = situ))+
  geom_point(pch = 1, alpha = 0.2)+
  geom_smooth()+
  scale_color_manual(name = "Situation", values = situcolors[1:2])+
  theme(legend.position = "none")
```

Now let's plot the CV (sd/mean)

```{r}
cvs <- measures %>%
  group_by(w, situ) %>%
  summarize(mn = mean(density, na.rm = T),
            sd = sd(density, na.rm = T),
            cv = sd/mn) %>%
  ungroup() %>%
  mutate(w_days = w)

cvs %>%
  filter(w %in% c(1, 5, 10, 16, 21, 25, 31, 36, 41, 46)) %>%
  ggplot(aes(x = w_days, y = cv, col = situ))+
  geom_line()+
  geom_point()+
  ylab("CV")+
  xlab("Time window (days)")+
  scale_color_manual(name = "Situation", values = c("firebrick3", situcolors))+
  theme(legend.position = "bottom",
        text = element_text(size = 16))

```

```{r}
## Density only, since that's most directly comparable to Caceres et al.
cvs %>%
  ggplot(aes(x = w_days, y = cv, col = situ))+
  geom_line()+
  geom_point()+
  ylab("CV")+
  xlab("Time window (days)")+
  scale_color_manual(name = "Situation", values = c("firebrick3", situcolors))+
  theme(legend.position = "bottom",
        text = element_text(size = 16))

cvs %>%
  filter(w %in% c(1, 5, 10, 16, 21, 25, 31, 36, 41, 46)) %>%
  ggplot(aes(x = w_days, y = cv, col = situ))+
  geom_line(linewidth = 1, alpha = 0.7)+
  #geom_point(size = 2, alpha = 0.7)+
  ylab("CV (Density)")+
  xlab("Time window (days)")+
  scale_color_manual(name = "Situation", values = c("firebrick3", situcolors))+
  theme(legend.position = "bottom",
        text = element_text(size = 16))+
  guides(color = guide_legend(override.aes = 
                                list(linewidth = 2, size = 3, alpha = 1)))
```

```{r}
## Look at the time series at various scales
measures %>%
  filter(w %in% c(1, 5, 10, 25)) %>%
  ggplot(aes(x = time, y = density, col = situ))+
  geom_line(aes(linewidth = situ, alpha = situ))+
  facet_wrap(~w, scales = "free_y")+
  scale_color_manual(name = "Situation", values = c("firebrick3", situcolors))+
  scale_linewidth_manual(values = c(0.5, 1, 0.5, 0.5))+
  scale_alpha_manual(values = c(0.5, 1, 0.5, 0.5))+
  guides(linewidth = "none", alpha = "none",
         color = guide_legend(override.aes = 
                                list(linewidth = 3, alpha = 1)))+
  ylab("Density")+
  xlab("Time")+
  theme(legend.position = "bottom",
        text = element_text(size = 16))

measures %>%
  filter(w %in% c(1, 5, 10, 25), situ == "feeding") %>%
  ggplot(aes(x = time, y = density))+
  geom_line(aes(linewidth = situ, alpha = situ), 
            col = cc$feedingColor, linewidth = 1, alpha = 1)+
  facet_wrap(~w, scales = "free_y")+
  guides(linewidth = "none", alpha = "none",
         color = guide_legend(override.aes = 
                                list(linewidth = 3, alpha = 1)))+
  ylab("Density")+
  xlab("Time")+
  theme(legend.position = "bottom",
        text = element_text(size = 16))
```
